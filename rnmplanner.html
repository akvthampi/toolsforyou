<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Recipe & Meal Planner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#0f172a;
      --muted:#94a3b8;
      --text:#e2e8f0;
      --primary:#6366f1;
      --primary-600:#5558ec;
      --danger:#ef4444;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --card-border:rgba(255,255,255,.08);
      --panel-grad1:rgba(255,255,255,.04);
      --panel-grad2:rgba(255,255,255,.02);
    }
    *{box-sizing:border-box; margin: 0; padding: 0;}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #1d2955, transparent 60%),
                  radial-gradient(800px 600px at 120% 10%, #1a3a6e, transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    .app{width:100%; margin:0; padding:20px;}
    .header{text-align:center;margin-bottom:20px; padding:0 10px;}
    .title{font-weight:700;font-size:2rem;margin:0 0 10px}
    .subtitle{color:var(--muted);margin:0; font-size:1.1rem;}

    .container{display:grid;grid-template-columns: 1.1fr .9fr;gap:20px; width:100%;}
    @media (max-width: 980px){.container{grid-template-columns:1fr}}

    .panel{
      background: linear-gradient(180deg, var(--panel-grad1), var(--panel-grad2));
      border:1px solid var(--card-border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
      overflow:hidden;
      min-height: 500px;
    }
    .panel-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .panel-title{font-weight:700; font-size:1.2rem;}
    .panel-body{padding:16px}

    .searchbar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .input{
      flex:1;min-width:240px;padding:12px 16px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);background:rgba(2,6,23,.6);
      color:var(--text);outline:none;transition:border-color .2s, box-shadow .2s;
      font-size: 1rem;
    }
    .input:focus{border-color:rgba(99,102,241,.6);box-shadow:0 0 0 4px rgba(99,102,241,.15)}
    .btn{
      appearance:none;border:none;border-radius:12px;padding:12px 18px;font-weight:600;cursor:pointer;
      transition:transform .08s, background .2s, box-shadow .2s; font-size: 1rem;
    }
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.primary{background:linear-gradient(180deg, var(--primary), var(--primary-600));color:white;box-shadow:0 8px 18px rgba(99,102,241,.35)}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.ghost{background:rgba(255,255,255,.05);color:var(--text);border:1px solid rgba(255,255,255,.12)}
    .btn.ghost:hover{background:rgba(255,255,255,.09)}

    .recipes-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px}
    .recipe-card{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;overflow:hidden;
      transition:transform .08s, box-shadow .2s, border-color .2s;
      cursor:pointer;
    }
    .recipe-card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(99,102,241,.18);border-color:rgba(99,102,241,.45)}
    .recipe-thumb{width:100%;height:160px;object-fit:cover;display:block}
    .recipe-content{padding:12px}
    .recipe-title{font-weight:700;margin:0 0 10px;font-size:1.1rem}
    .card-actions{display:flex;justify-content:flex-end}
    .btn.add{background:rgba(99,102,241,.16);color:#fff;border:1px solid rgba(99,102,241,.5);padding:8px 12px;border-radius:10px; font-size: 0.9rem;}
    .btn.add:hover{background:rgba(99,102,241,.25)}
    .empty-state{color:var(--muted);padding:16px;text-align:center;border:1px dashed rgba(255,255,255,.12);border-radius:12px;margin-top:16px; font-size: 1rem;}

    .planner-grid{display:grid;grid-template-columns: repeat(7, 1fr);gap:12px;padding:12px}
    @media (max-width:1400px){ .planner-grid{grid-template-columns: repeat(4, 1fr)} }
    @media (max-width:1100px){ .planner-grid{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width:800px){ .planner-grid{grid-template-columns: repeat(2, 1fr)} }
    @media (max-width:520px){ .planner-grid{grid-template-columns: 1fr} }
    .day-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .day-header{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);font-weight:700; font-size: 1.1rem; background: rgba(255,255,255,0.05);}
    .meal-slot{padding:12px;min-height:130px;border-bottom:1px dashed rgba(255,255,255,.08);transition: background .2s, outline .2s; position: relative;}
    .meal-slot:last-child{border-bottom:none}
    .slot-title{color:var(--muted);font-size:.95rem;margin-bottom:8px; font-weight: 600;}
    .meal-slot.dragover{outline:2px dashed var(--primary);outline-offset:-6px;background:rgba(99,102,241,.08)}
    .meal-slot.empty:after{content:"Drop recipe here";color:var(--muted);font-size:.9rem;position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);text-align:center;}

    .meal-item{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;margin-bottom:10px;cursor:grab}
    .meal-item:active{cursor:grabbing}
    .meal-thumb{width:36px;height:36px;border-radius:8px;object-fit:cover; border: 1px solid rgba(255,255,255,0.1);}
    .meal-name{flex:1;font-size:1rem}
    .meal-remove{background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,.4);color:#ff6b6b;padding:5px 9px;border-radius:8px;cursor:pointer; font-size: 0.9rem;}
    .meal-remove:hover{background:rgba(239,68,68,0.3);color:#ff5252;}

    .assign-popup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:30}
    .assign-card{width:min(480px, 92vw);background: linear-gradient(180deg, var(--panel-grad1), var(--panel-grad2));border:1px solid var(--card-border);border-radius:16px;box-shadow:var(--shadow);padding:20px}
    .assign-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(2,6,23,.6);color:var(--text);outline:none;transition:border-color .2s, box-shadow .2s; font-size: 1rem;}
    .select:focus{border-color:rgba(99,102,241,.6);box-shadow:0 0 0 4px rgba(99,102,241,.15)}
    .assign-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:16px}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:40}
    .modal-card{width:min(900px, 95vw);max-height:90vh;overflow:auto;background: rgba(15, 23, 42, 0.95);border:1px solid var(--card-border);border-radius:16px;box-shadow:var(--shadow)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .modal-title{font-weight:700;font-size:1.5rem}
    .modal-close{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);color:#fff;padding:6px 12px;border-radius:10px;cursor:pointer; font-size: 1rem;}
    .modal-close:hover{background:rgba(255,255,255,.1)}
    .modal-body{padding:16px}
    .modal-top{display:grid;grid-template-columns: 320px 1fr;gap:16px}
    @media (max-width:780px){ .modal-top{grid-template-columns:1fr} }
    .modal-img{width:100%;height:240px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.12)}
    .ingredients{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media (max-width:600px){ .ingredients{grid-template-columns:1fr} }
    .ing-item{background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.12);border-radius:10px;padding:10px; font-size: 0.95rem;}
    .section-caption{color:var(--muted);margin:12px 0 8px;font-weight:600;font-size:1.2rem}

    .footer{text-align:center;color:var(--muted);font-size:.95rem;margin-top:20px; padding: 0 10px;}
  </style>
</head>
<body>
  <main class="app">
    <header class="header">
      <h1 class="title">Recipe & Meal Planner</h1>
      <p class="subtitle">Search recipes, view details, and plan the week with drag-and-drop and autosave.</p>
    </header>

    <section class="container">
      <section class="panel" id="discover">
        <div class="panel-header">
          <div class="panel-title">Discover Recipes</div>
          <div></div>
        </div>
        <div class="panel-body">
          <div class="searchbar">
            <input id="search-input" type="search" class="input" placeholder="Search meals, e.g., chicken, pasta, curry"/>
            <button id="search-btn" class="btn primary">Search</button>
            <button id="random-btn" class="btn ghost">Random</button>
          </div>
          <div id="results" class="recipes-grid"></div>
          <div id="results-empty" class="empty-state" style="display:none;">No recipes found. Try another search.</div>
        </div>
      </section>

      <section class="panel" id="planner">
        <div class="panel-header">
          <div class="panel-title">Weekly Meal Planner</div>
          <div class="hint" style="color:var(--muted)">Drag cards between slots. Changes auto-save.</div>
        </div>
        <div class="panel-body">
          <div class="planner-grid" id="planner-grid"></div>
        </div>
      </section>
    </section>

    <footer class="footer">
      <p>Built with semantic HTML, modern CSS, and vanilla JS.</p>
    </footer>
  </main>

  <!-- Assign to plan -->
  <div class="assign-popup" id="assign-popup" aria-modal="true" role="dialog">
    <div class="assign-card">
      <div class="panel-title">Add to Meal Plan</div>
      <div class="assign-row">
        <select id="assign-day" class="select" aria-label="Select day"></select>
        <select id="assign-slot" class="select" aria-label="Select meal slot">
          <option value="breakfast">Breakfast</option>
          <option value="lunch">Lunch</option>
          <option value="dinner">Dinner</option>
        </select>
      </div>
      <div class="assign-actions">
        <button id="assign-cancel" class="btn ghost">Cancel</button>
        <button id="assign-confirm" class="btn primary">Add</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="modal-title">Recipe</div>
        <button class="modal-close" id="modal-close">X</button>
      </div>
      <div class="modal-body">
        <div class="modal-top">
          <img id="modal-img" class="modal-img" alt="Meal image"/>
          <div>
            <div class="section-caption">Ingredients</div>
            <div id="modal-ings" class="ingredients"></div>
          </div>
        </div>
        <div class="section-caption">Instructions</div>
        <div id="modal-instructions" style="white-space:pre-line;line-height:1.5"></div>
      </div>
    </div>
  </div>

  <script>
    // API and helpers
    const API = {
      searchByName: (q) => `https://www.themealdb.com/api/json/v1/1/search.php?s=${encodeURIComponent(q || '')}`,
      lookupById:   (id) => `https://www.themealdb.com/api/json/v1/1/lookup.php?i=${id}`,
      searchByFirst:(ch) => `https://www.themealdb.com/api/json/v1/1/search.php?f=${encodeURIComponent(ch)}`,
      random:       () => 'https://www.themealdb.com/api/json/v1/1/random.php'
    }; // TheMealDB endpoints with meals array or null.

    const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    const SLOTS = ['breakfast','lunch','dinner'];

    const $ = (s, c=document) => c.querySelector(s);
    const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));
    const create = (tag, cls) => { const el=document.createElement(tag); if(cls) el.className=cls; return el; };

    // State + persistence
    const STORAGE_KEY = 'meal_planner_v3';
    let planner = {};

    const safeLoadPlanner = () => {
      let raw=null;
      try { raw = localStorage.getItem(STORAGE_KEY); } catch {}
      try { planner = raw ? JSON.parse(raw) || {} : {}; } catch { planner = {}; }
      DAYS.forEach(d => {
        if(!planner[d]) planner[d] = {};
        SLOTS.forEach(s => { if(!Array.isArray(planner[d][s])) planner[d][s] = []; });
      });
    }; // Defensive localStorage load.

    const savePlanner = () => {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(planner)); } catch {}
    }; // Persist changes.

    // Planner rendering
    const plannerGrid = $('#planner-grid');

    const removeMealByUid = (uid) => {
      if(!uid) return;
      DAYS.forEach(d => SLOTS.forEach(s => {
        const arr = planner[d][s];
        const idx = arr.findIndex(m => m._uid === uid);
        if(idx >= 0) arr.splice(idx,1);
      }));
    };

    const mealItem = (meal, day, slot) => {
      const item = create('div','meal-item');
      item.draggable = true;
      item.dataset.uid = meal._uid;
      const img = create('img','meal-thumb'); img.src = meal.strMealThumb || ''; img.alt = 'Thumb';
      const name = create('div','meal-name'); name.textContent = meal.strMeal;
      const rm = create('button','meal-remove'); rm.textContent = 'x';
      
      // Fixed remove functionality - store day and slot in the button itself
      rm.dataset.day = day;
      rm.dataset.slot = slot;
      rm.dataset.uid = meal._uid;
      
      rm.addEventListener('click', (e) => {
        e.stopPropagation();
        const day = e.target.dataset.day;
        const slot = e.target.dataset.slot;
        const uid = e.target.dataset.uid;
        
        if(day && slot && uid){
          const arr = planner[day][slot];
          const idx = arr.findIndex(m => m._uid === uid);
          if(idx >= 0) {
            arr.splice(idx,1);
            item.remove();
            savePlanner();
            updateEmptySlots();
          }
        }
      });
      
      item.addEventListener('dragstart', (e) => {
        e.dataTransfer.effectAllowed = 'move';
        const payload = { idMeal: meal.idMeal, strMeal: meal.strMeal, strMealThumb: meal.strMealThumb, _uid: meal._uid };
        try { e.dataTransfer.setData('text/plain', JSON.stringify(payload)); } catch {}
        item.classList.add('dragging');
      });
      item.addEventListener('dragend', () => item.classList.remove('dragging'));
      item.append(img, name, rm);
      return item;
    };

    // Function to update empty slots display
    const updateEmptySlots = () => {
      $$('.meal-slot').forEach(slot => {
        const day = slot.dataset.day;
        const slotType = slot.dataset.slot;
        const hasMeals = planner[day][slotType].length > 0;
        
        if (hasMeals) {
          slot.classList.remove('empty');
        } else {
          slot.classList.add('empty');
        }
      });
    };

    const renderPlanner = () => {
      plannerGrid.innerHTML = '';
      DAYS.forEach(day => {
        const dayCard = create('div','day-card');
        const head = create('div','day-header'); head.textContent = day;
        dayCard.appendChild(head);
        SLOTS.forEach(slot => {
          const slotEl = create('div','meal-slot'); 
          slotEl.dataset.day = day; 
          slotEl.dataset.slot = slot;
          const title = create('div','slot-title'); 
          title.textContent = slot[0].toUpperCase() + slot.slice(1);
          slotEl.appendChild(title);

          // DnD
          slotEl.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move'; 
            slotEl.classList.add('dragover'); 
          });
          slotEl.addEventListener('dragleave', () => slotEl.classList.remove('dragover'));
          slotEl.addEventListener('drop', (e) => {
            e.preventDefault();
            slotEl.classList.remove('dragover');
            let txt = ''; 
            try { txt = e.dataTransfer.getData('text/plain'); } catch {}
            if(!txt) return;
            let data=null; 
            try { data = JSON.parse(txt); } catch {}
            if(!data || !data.idMeal) return;
            if(data._uid) removeMealByUid(data._uid);
            const uid = data._uid || `${data.idMeal}-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
            const meal = { idMeal: data.idMeal, strMeal: data.strMeal, strMealThumb: data.strMealThumb, _uid: uid };
            planner[day][slot].push(meal);
            slotEl.appendChild(mealItem(meal, day, slot));
            savePlanner();
            updateEmptySlots();
          });

          planner[day][slot].forEach(m => slotEl.appendChild(mealItem(m, day, slot)));
          dayCard.appendChild(slotEl);
        });
        plannerGrid.appendChild(dayCard);
      });
      
      // Update empty slots after rendering
      setTimeout(updateEmptySlots, 0);
    };

    // Discovery
    const resultsGrid = $('#results');
    const resultsEmpty = $('#results-empty');
    const searchInput = $('#search-input');
    const searchBtn = $('#search-btn');
    const randomBtn = $('#random-btn');

    const fetchJSON = async (url) => {
      try {
        const res = await fetch(url);
        if(!res.ok) throw new Error('Network error');
        return res.json();
      } catch (error) {
        console.error('Fetch error:', error);
        return { meals: null };
      }
    };

    const searchMeals = async (q) => {
      try { 
        const data = await fetchJSON(API.searchByName(q)); 
        return Array.isArray(data.meals) ? data.meals : []; 
      } catch { 
        return []; 
      }
    };

    const lookupMeal = async (id) => {
      try { 
        const data = await fetchJSON(API.lookupById(id)); 
        return (data.meals && data.meals[0]) || null; 
      } catch { 
        return null; 
      }
    };

    const randomMeal = async () => {
      try { 
        const data = await fetchJSON(API.random()); 
        return (data.meals && data.meals[0]) || null; 
      } catch { 
        return null; 
      }
    };

    const renderResults = (meals) => {
      resultsGrid.innerHTML = '';
      if(!meals || meals.length === 0){
        resultsEmpty.style.display = '';
        return;
      }
      resultsEmpty.style.display = 'none';
      meals.forEach(meal => {
        const card = create('div','recipe-card');
        const img = create('img','recipe-thumb'); 
        img.src = meal.strMealThumb || ''; 
        img.alt = meal.strMeal || 'Meal';
        const content = create('div','recipe-content');
        const title = create('div','recipe-title'); 
        title.textContent = meal.strMeal || 'Recipe';
        const actions = create('div','card-actions');
        const addBtn = create('button','btn add'); 
        addBtn.type='button'; 
        addBtn.textContent='Add to Plan';

        card.addEventListener('click', () => openModal(meal));
        addBtn.addEventListener('click', (e) => { 
          e.stopPropagation(); 
          openAssignPopup(meal); 
        });

        actions.appendChild(addBtn);
        content.append(title, actions);
        card.append(img, content);
        resultsGrid.appendChild(card);
      });
    };

    // Modal
    const modal = $('#modal'), modalClose = $('#modal-close');
    const modalTitle = $('#modal-title'), modalImg = $('#modal-img');
    const modalIngs = $('#modal-ings'), modalInstr = $('#modal-instructions');

    const buildIngredientsList = (meal) => {
      const out = [];
      for(let i=1;i<=20;i++){
        const ing = (meal[`strIngredient${i}`]||'').trim();
        const meas = (meal[`strMeasure${i}`]||'').trim();
        if(ing) out.push({ing, meas});
      }
      return out;
    };

    const openModal = async (meal) => {
      const full = meal.idMeal ? await lookupMeal(meal.idMeal) : meal;
      if(!full) return;
      modalTitle.textContent = full.strMeal || 'Recipe';
      modalImg.src = full.strMealThumb || '';
      modalIngs.innerHTML = '';
      const list = buildIngredientsList(full);
      if(list.length === 0){
        const i = create('div','ing-item'); 
        i.textContent='No ingredients listed.'; 
        modalIngs.appendChild(i);
      } else {
        list.forEach(({ing,meas}) => {
          const i = create('div','ing-item'); 
          i.textContent = meas ? `${ing} — ${meas}` : ing; 
          modalIngs.appendChild(i);
        });
      }
      modalInstr.textContent = full.strInstructions || 'No instructions provided.';
      modal.style.display = 'flex';
    };
    modalClose.addEventListener('click', () => modal.style.display='none');
    modal.addEventListener('click', (e) => { 
      if(e.target === modal) modal.style.display='none'; 
    });

    // Assign popup
    const assignPopup = $('#assign-popup');
    const assignDay = $('#assign-day');
    const assignSlot = $('#assign-slot');
    const assignCancel = $('#assign-cancel');
    const assignConfirm = $('#assign-confirm');
    let pendingAssignMeal = null;

    const populateAssignDays = () => {
      assignDay.innerHTML = '';
      DAYS.forEach(d => { 
        const opt=document.createElement('option'); 
        opt.value=d; 
        opt.textContent=d; 
        assignDay.appendChild(opt); 
      });
    };
    
    const openAssignPopup = (meal) => { 
      pendingAssignMeal = meal; 
      assignPopup.style.display='flex'; 
    };
    
    const closeAssignPopup = () => { 
      pendingAssignMeal=null; 
      assignPopup.style.display='none'; 
    };
    
    assignCancel.addEventListener('click', closeAssignPopup);
    assignPopup.addEventListener('click', (e) => { 
      if(e.target === assignPopup) closeAssignPopup(); 
    });
    
    assignConfirm.addEventListener('click', () => {
      if(!pendingAssignMeal) return;
      const day = assignDay.value, slot = assignSlot.value;
      const uid = `${pendingAssignMeal.idMeal}-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
      const m = { 
        idMeal: pendingAssignMeal.idMeal, 
        strMeal: pendingAssignMeal.strMeal, 
        strMealThumb: pendingAssignMeal.strMealThumb, 
        _uid: uid 
      };
      planner[day][slot].push(m);
      savePlanner();
      const slotEl = document.querySelector(`.meal-slot[data-day="${day}"][data-slot="${slot}"]`);
      if(slotEl) {
        slotEl.appendChild(mealItem(m, day, slot));
        slotEl.classList.remove('empty');
      }
      closeAssignPopup();
    });

    // Search controls
    const doSearch = async () => { 
      renderResults(await searchMeals(searchInput.value.trim())); 
    };
    
    searchBtn.addEventListener('click', doSearch);
    searchInput.addEventListener('keydown', (e) => { 
      if(e.key==='Enter') doSearch(); 
    });
    randomBtn.addEventListener('click', async () => { 
      const m = await randomMeal(); 
      renderResults(m ? [m] : []); 
    });

    // Init
    populateAssignDays();
    safeLoadPlanner();
    renderPlanner();
    
    // Initial load with some recipes
    (async () => {
      try {
        const data = await fetchJSON('https://www.themealdb.com/api/json/v1/1/search.php?f=b');
        renderResults(Array.isArray(data.meals) ? data.meals : []);
      } catch { 
        renderResults([]); 
      }
    })();
  </script>
</body>
</html>
